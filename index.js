!function(e,t){e&&!e.getElementById("livereloadscript")&&((t=e.createElement("script")).async=1,t.src="//"+(self.location.host||"localhost").split(":")[0]+":35729/livereload.js?snipver=1",t.id="livereloadscript",e.getElementsByTagName("head")[0].appendChild(t))}(self.document),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("rxjs")):"function"==typeof define&&define.amd?define(["lodash","rxjs"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).CanvasTable=t(e._,e.rxjs)}(this,(function(e,t){"use strict";function i(e,t,i,s){var h,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var n=e.length-1;n>=0;n--)(h=e[n])&&(o=(r<3?h(o):r>3?h(t,i,o):h(t,i))||o);return r>3&&o&&Object.defineProperty(t,i,o),o}function s(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}"function"==typeof SuppressedError&&SuppressedError;const h="𒆙 [CanvasTable] ",r="rgba(0, 0, 0, 0.25)";var o;!function(e){e[e.CELL_CLICK=0]="CELL_CLICK",e[e.HEADER_CELL_CLICK=1]="HEADER_CELL_CLICK",e[e.ROW_CLICK=2]="ROW_CLICK",e[e.COL_RESIZE=3]="COL_RESIZE",e[e.CELL_DBCLICK=4]="CELL_DBCLICK",e[e.ROW_DBCLICK=5]="ROW_DBCLICK",e[e.MOUSEMOVE=6]="MOUSEMOVE",e[e.MOUSELEAVE=7]="MOUSELEAVE"}(o||(o={}));const n={},a={},d="#000000",l=["padding","font","fontSize","color","background","borderRadius","border"];var c,u;function f(e){console.log(`%c${h}%c${e}`,"color: blue","color: gray")}function g(e={}){const{enabled:t,format:i,logger:s=f,id:h}=e;return function(e,r,o){const n=o.value;return o.value=function(...e){if(!t)return n.apply(this,e);const o=h?`${h} ${String(r)}`:`${String(r)}`,a=performance.now(),d=n.apply(this,e),l=performance.now(),c=function(e="simple",t,i){switch(e){case"simple":default:return`方法 ${t} 执行时间：${i.toFixed(2)}ms`;case"json":return JSON.stringify({method:t,time:i})}}(i,o,l-a);return null==s||s(c),d},o}}!function(e){e.TABLE="TABLE",e.TABLE_HEADER="TABLE_HEADER",e.TABLE_HEADER_ROW="TABLE_HEADER_ROW",e.TABLE_HEADER_COLUMN="TABLE_HEADER_COLUMN",e.TABLE_BODY="TABLE_BODY",e.TABLE_BODY_ROW="TABLE_BODY_ROW",e.TABLE_BODY_COLUMN="TABLE_BODY_COLUMN",e.TABLE_FOOTER="TABLE_FOOTER",e.TABLE_FOOTER_ROW="TABLE_FOOTER_ROW",e.TABLE_FOOTER_COLUMN="TABLE_FOOTER_COLUMN",e.TABLE_SCROLLBAR_X="TABLE_SCROLLBAR_X",e.TABLE_SCROLLBAR_Y="TABLE_SCROLLBAR_Y",e.DEFAULT="DEFAULT"}(c||(c={})),function(e){e.SCROLLBAR_X="SCROLLBAR_X",e.SCROLLBAR_Y="SCROLLBAR_Y",e.HEADER_FIXED_LEFT="HEADER_FIXED_LEFT",e.HEADER_FIXED_RIGHT="HEADER_FIXED_RIGHT",e.BODY_FIXED_LEFT="BODY_FIXED_LEFT",e.BODY_FIXED_RIGHT="BODY_FIXED_RIGHT",e.SUMMARY_FIXED_LEFT="SUMMARY_FIXED_LEFT",e.SUMMARY_FIXED_RIGHT="SUMMARY_FIXED_RIGHT",e.HEADER_OTHER="HEADER_OTHER",e.BODY_OTHER="BODY_OTHER",e.SUMMARY_OTHER="SUMMARY_OTHER"}(u||(u={}));const p=e=>{e.style.background="#ff0"},R=e=>{e.style.background="transparent"},_=e=>{var t;return{type:e.type,rect:e.rect,data:e.data,style:null!==(t=e.style)&&void 0!==t?t:{},_eventHandlers:{mouseenter:[p],mouseleave:[R],click:[]}}};function E(e,t){e.rect=t}function v(e,t){e.children||(e.children=[]),t=Array.isArray(t)?t:[t];for(const i of t)e.children.push(i)}function m(e,t,i){Array.isArray(e._eventHandlers[t])||(e._eventHandlers[t]=[]),e._eventHandlers[t].push(i)}function y(e,t,i){const s=e._eventHandlers[t];null==s||s.forEach((t=>{t(e,i)}))}class NodeStore{constructor(){this._store={},this._hoverNodeListMap=new Map}setNode(e,t){var i;this._store[e]||(this._store[e]=[]),null===(i=this._store[e])||void 0===i||i.push(t)}clearNode(e){e=Array.isArray(e)?e:[e];for(let t=0;t<e.length;t++){const i=e[t];this._store[i]=[]}}getNode(e){var t;return null!==(t=this._store[e])&&void 0!==t?t:[]}setHoverNodes(e){e.forEach((e=>{this._hoverNodeListMap.set(e,e)}))}getHoverNode(e){return this._hoverNodeListMap.get(e)}forEachHoverNode(e){this._hoverNodeListMap.forEach(e)}clearHoverNodes(){this._hoverNodeListMap.clear()}}const L=new WeakMap,H=new Map;class CanvasTable{get font(){return`${this.fontSize}px ${this.fontFamily}`}get scrollOffsetX(){return this._scrollOffsetX}set scrollOffsetX(t){const i=this.wrapperWidth-this.fixedRightWidth-this.fixedLeftWidth,s=this.contentWidth-i>0?this.contentWidth-i:0;if((t=e.inRange(t,0,s+1)?t:t<0?0:s)!==this._scrollOffsetX){this._scrollOffsetX=t;[...this._nodeStore.getNode(u.BODY_OTHER),...this._nodeStore.getNode(u.HEADER_OTHER)].forEach((e=>{e.scrollOffsetX=t}))}}get scrollOffsetY(){return this._scrollOffsetY}set scrollOffsetY(t){const i=this.wrapperHeight-this.headerHeight-this.summaryHeight,s=this.bodyHeight-i>0?this.bodyHeight-i:0;if((t=e.inRange(t,0,s+1)?t:t<0?0:s)!==this._scrollOffsetY){this._scrollOffsetY=t;const e=this._nodeStore.getNode(u.BODY_OTHER),i=this._nodeStore.getNode(u.BODY_FIXED_LEFT),s=this._nodeStore.getNode(u.BODY_FIXED_RIGHT);e.concat(i,s).forEach((e=>{e.scrollOffsetY=t})),this._verticalStartIdx=function(e,t,i){let s=0,h=0;for(let r=0;r<e.length;r++){if(s+=i(e[r]),s>=t)return r;h=r}return h}(this.dataRowHeights,t,(e=>e.value))}}constructor(e){this.isInitialized=!1,this.scaleRatio=window.devicePixelRatio,this.canvasBaseStyle={},this.tableBaseStyle={},this.fontSize=14,this.fontFamily="Arial",this._scrollOffsetX=0,this._scrollOffsetY=0,this.dataRowHeights=[],this._tableDataRowHeightSubscription=null,this._displayRows=[],this._displayColumns=[],this._fixedLeftFlattenLeafNodeColumns=[],this._fixedRightFlattenLeafNodeColumns=[],this._otherFlattenLeafNodeColumns=[],this.rawColumns=[],this.depth=0,this.fixedLeftColumns=[],this.fixedRightColumns=[],this.otherColumns=[],this.columns=[],this.tableData=[],this.wrapperWidth=0,this.wrapperHeight=0,this.headerHeight=0,this.rowHeight=30,this.bodyHeight=0,this.summaryHeight=0,this.headerRowHeight=42,this.widthConfig={},this.minWidthTotal=0,this.defaultWidthTotal=0,this.currentColumns=[],this.bodyColumns=[],this.fixedLeftWidth=0,this.fixedRightWidth=0,this.contentWidth=0,this.hideHeader=!1,this._nodeStore=new NodeStore,this._horizontalCenterRange=[0,0],this._verticalCenterRange=[0,0],this._verticalStartIdx=0,this._horizontalStartIdx=0,this._columnLeftMap=L,this._rowTopMap=H,this.init(e)}init(e){const t="function"==typeof e.target?e.target():e.target,{width:i,height:s}=t.getBoundingClientRect();this.wrapperWidth=i,this.wrapperHeight=s,this.appendEssentialElements(t),this.scaleRatio=this.scaleRatio<1?1:this.scaleRatio,this.setCanvasHeight(),this.setBaseStyle(),this.setColumns(e.columns),this.initColumns(this.rawColumns),this.setTableData(e.tableData),this.render(),this.isInitialized=!0}initTableScrollbar(){}calcVerticalScrollbarRect(){const e=this.wrapperHeight-this.headerHeight-this.summaryHeight,t=this.wrapperHeight-this.headerHeight,i=this.bodyHeight/t,s=e/i,h=s<10,r=h?10:s,o=h?(t-s)/(t-r):1;this.scrollOffsetY;return{rect:{x:this.wrapperWidth-this.summaryHeight-5,y:this.headerHeight,width:5,height:r},scaleRatio:i,minScrollBarScaleRatio:o}}initVerticalScrollbarNode(){const{rect:e,scaleRatio:t,minScrollBarScaleRatio:i}=this.calcVerticalScrollbarRect(),s=_({type:c.TABLE_SCROLLBAR_Y,rect:e,style:{background:r,borderRadius:5}});m(s,"mouseenter",(()=>{s.style.background="#ff0"})),m(s,"mouseleave",(()=>{s.style.background=r}));let h=!1,o=0,n=0;m(s,"mousedown",((e,s)=>{h=!0,o=s.pageY,n=this.scrollOffsetY/t/i,document.addEventListener("mousemove",a),document.addEventListener("mouseup",d)}));const a=e=>{if(h){const s=e.pageY-o;this.scrollOffsetY=(s+n)*t*i}},d=()=>{h=!1,o=0,n=0,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",d)};return this._nodeStore.setNode(u.SCROLLBAR_Y,s),s}calcHorizontalScrollbarRect(){const e=this.wrapperWidth-this.fixedLeftWidth-this.fixedRightWidth,t=this.contentWidth/this.wrapperWidth,i=e/t,s=i<10,h=s?10:i,r=s?(this.wrapperWidth-i)/(this.wrapperWidth-h):1;return{rect:{x:this.scrollOffsetX/t/r,y:this.wrapperHeight-this.summaryHeight-5,width:h,height:5},scaleRatio:t,minScrollBarScaleRatio:r}}initHorizontalScrollbarNode(){const{rect:e}=this.calcHorizontalScrollbarRect(),t=_({type:c.TABLE_SCROLLBAR_Y,rect:e,style:{background:r,borderRadius:5}});m(t,"mouseenter",(()=>{t.style.background="#ff0"})),m(t,"mouseleave",(()=>{t.style.background=r}));let i=!1,s=0,h=0,o=1,n=1;m(t,"mousedown",((e,t)=>{const r=this.calcHorizontalScrollbarRect();o=r.scaleRatio,n=r.minScrollBarScaleRatio,i=!0,s=t.pageX,h=this.scrollOffsetX/o/n,document.addEventListener("mousemove",a),document.addEventListener("mouseup",d)}));const a=e=>{if(i){const t=(e.pageX-s+h)*o*n;this.scrollOffsetX=t}},d=()=>{i=!1,s=0,h=0,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",d)};return this._nodeStore.setNode(u.SCROLLBAR_X,t),t}setBaseStyle(){Object.assign(this.canvasBaseStyle,a),Object.assign(this.tableBaseStyle,n)}setCanvasHeight(){this.context&&(this.context.canvas.height=this.calcRealPixel(this.wrapperHeight),this.context.translate(.5,.5),this.context.scale(this.scaleRatio,this.scaleRatio))}setDisplayRows(){}setDisplayColumns(){const t=[this.scrollOffsetX,this.wrapperWidth-this.fixedRightWidth],{columns:i}=this.otherColumns.reduce(((i,s)=>{const h=i.left,r=s.$width.value+i.left;return i.left+=r,(e.inRange(h,...t)||e.inRange(r,...t)||e.inRange(t[0],h,r)&&e.inRange(t[1],h,r))&&i.columns.push(s),i}),{columns:[],left:0});this._displayColumns=i}createCanvas(){const e=document.createElement("canvas");return e.width=this.calcRealPixel(this.wrapperWidth),e.height=this.calcRealPixel(this.wrapperHeight),e.style.width=`${this.wrapperWidth}px`,e.style.height=`${this.wrapperHeight}px`,this.context=e.getContext("2d"),this.bindCanvasWheelEvent(e),this.bindCanvasMouseEvent(e),e}getPointerEventNode(t){const{x:i,y:s}=t;let h=[];const r=(t,h,o=[],n={scrollOffsetX:0,scrollOffsetY:0})=>{const a=o[o.length-1],{scrollOffsetX:d=0,scrollOffsetY:l=0}=a||{},u={scrollOffsetX:d+n.scrollOffsetX,scrollOffsetY:l+n.scrollOffsetY};for(let n=0;n<h.length;n++){const a=h[n],{rect:{x:d,y:l,height:f,width:g},children:p}=a,R=d-u.scrollOffsetX,_=R+g;if(e.inRange(i,R,_)){const i=l-u.scrollOffsetY,h=i+f;if(e.inRange(s,i,h)){if(o.push(a),!(null==p?void 0:p.length))break;if(a.type===c.TABLE_BODY){const e=this.getVisibleRowNodes(p);r(t,e,o,u)}else r(t,p,o,u)}}}return o};for(const e in u){const t=u[e],o=this._nodeStore.getNode(t);if((null==o?void 0:o.length)&&(h=r({x:i,y:s},o),null==h?void 0:h.length))break}return h}bindCanvasMouseEvent(e){e.addEventListener("mousedown",(e=>{this._nodeStore.forEachHoverNode((t=>{y(t,"mousedown",e)}))})),document.addEventListener("mouseup",(e=>{this._nodeStore.forEachHoverNode((t=>{y(t,"mouseup",e)}))})),e.addEventListener("click",(e=>{this._nodeStore.forEachHoverNode((t=>{y(t,"click",e)}))})),e.addEventListener("mousemove",(e=>{const t=this.getPointerEventNode({x:e.offsetX,y:e.offsetY});this._nodeStore.forEachHoverNode((i=>{t.includes(i)?y(i,"mousemove",e):y(i,"mouseleave",e)})),t.reverse().forEach((t=>{y(t,"mouseenter",e)})),this._nodeStore.clearHoverNodes(),this._nodeStore.setHoverNodes(t)})),e.addEventListener("mouseleave",(e=>{this._nodeStore.forEachHoverNode((t=>{y(t,"mouseleave",e)}))}))}bindCanvasWheelEvent(e){e.addEventListener("wheel",(e=>{e.stopPropagation(),e.preventDefault(),this.scrollOffsetX+=e.deltaX,this.scrollOffsetY+=e.deltaY}))}calcRealPixel(e){return e*this.scaleRatio}appendEssentialElements(e){const t=document.createElement("div"),i=this.createCanvas();t.append(i),e.appendChild(t)}getCanvasContext(){return this.context}rerender(){this.isInitialized&&this.render()}doRender(e){const t=this.getCanvasContext();t.beginPath(),t.save(),e(t),t.restore(),t.closePath()}render(){requestAnimationFrame((()=>{var e;const t=this.getCanvasContext();t.clearRect(0,0,this.wrapperWidth,this.wrapperHeight),t.beginPath(),(null===(e=this.tableData)||void 0===e?void 0:e.length)?this.renderBody():this.renderNoData(),this.renderHeader(),this.renderSummary(),this.renderScrollbar(),this.render()}))}getHeaderDepth(e){let t=0;const i=(e,s=1)=>{t=Math.max(t,s),e.forEach((e=>{var t;(null===(t=e.children)||void 0===t?void 0:t.length)&&i(e.children,s+1)}))};return i(e),t}fillSelectionFormatter(e){}getCellWidth(e,t,i){return 0}pushSlot(e){}getVisibleColumns(){return this.columns}renderHeader(){const e=this._nodeStore.getNode(u.HEADER_OTHER),t=this._nodeStore.getNode(u.HEADER_FIXED_LEFT),i=this._nodeStore.getNode(u.HEADER_FIXED_RIGHT),s=e.concat(t,i);this.renderNodes(s)}getVisibleRowNodes(t){var i;const{_horizontalCenterRange:s,_verticalCenterRange:h}=this,r=[];let o=!1;for(let s=this._verticalStartIdx;s<t.length;s++){const n=t[s],a=this._rowTopMap.get(null===(i=n.data)||void 0===i?void 0:i.row),d=this.dataRowHeights[s].value,l=a+this.headerHeight-this.scrollOffsetY,c=l+d,u=e.inRange(l,...h)||e.inRange(c,...h);if(u)o=!0,r.push(n);else if(o&&!u)break}return r}renderNodes(t=[]){const{_horizontalCenterRange:i,_verticalCenterRange:s}=this;t.forEach((t=>{var s,h;switch(t.type){case c.TABLE_HEADER:case c.TABLE_HEADER_ROW:this.renderNodes(t.children);break;case c.TABLE_HEADER_COLUMN:{const{rect:{x:e,y:i,width:s,height:h},style:{fixed:r,background:o},data:{column:n}}=t,a=L.get(n),d={x:r?a.value:a.value-this.scrollOffsetX,y:i,width:n.$width.value,height:h,bg:o};this.renderNode(t,d);break}case c.TABLE_BODY:{const{children:e=[]}=t,i=this.getVisibleRowNodes(e);this.renderNodes(i);break}case c.TABLE_BODY_ROW:{const{children:r=[]}=t,o=[];let n=!1;for(let a=this._horizontalStartIdx;a<r.length;a++){const d=r[a],l=L.get(null===(s=d.data)||void 0===s?void 0:s.column),c=null===(h=d.data)||void 0===h?void 0:h.column.$width.value,u=l.value-this.scrollOffsetX,f=u+c,g=t.style.fixed||e.inRange(u,...i)||e.inRange(f,...i);if(g)n=!0,o.push(d);else if(n&&!g)break}this.renderNodes(o);break}case c.TABLE_BODY_COLUMN:const{rect:{x:r,y:o,width:n,height:a},style:{fixed:d,background:l},data:{column:u,row:f,rowIdx:g}}=t,p=L.get(u),R=H.get(f),_={x:d?p.value:p.value-this.scrollOffsetX,y:this.headerHeight+R-this.scrollOffsetY,width:u.$width.value,height:this.dataRowHeights[g].value,bg:l};this.renderNode(t,_)}}))}renderBody(){const e=[this.fixedLeftWidth,this.wrapperWidth-this.fixedRightWidth+1],t=this.headerHeight,i=[t,t+(this.wrapperHeight-this.headerHeight-this.summaryHeight)+1];this._horizontalCenterRange=e,this._verticalCenterRange=i;const s=this._nodeStore.getNode(u.BODY_OTHER),h=this._nodeStore.getNode(u.BODY_FIXED_LEFT),r=this._nodeStore.getNode(u.BODY_FIXED_RIGHT),o=s.concat(h,r);this.renderNodes(o)}renderBody1(){const t=[this.fixedLeftWidth,this.wrapperWidth-this.fixedRightWidth+1],i=this.headerHeight,s=[i,i+(this.wrapperHeight-this.headerHeight-this.summaryHeight)+1],h=(e,t,i,s,h=(()=>!0))=>{e.reduce(((e,i)=>{const{left:r}=e,o=r+i.$width.value;if(h(r,o)){const e={x:r,y:s,width:i.$width.value,height:this.rowHeight};this.renderCell(i,e,!1,t)}return e.left+=i.$width.value,e}),{left:i})},r=this.tableData,o=this._otherFlattenLeafNodeColumns,n=this._fixedLeftFlattenLeafNodeColumns,a=this._fixedRightFlattenLeafNodeColumns;r.reduce(((i,r,d)=>{const l=i+this.headerHeight-this.scrollOffsetY,c=l+this.dataRowHeights[d].value;return(e.inRange(l,...s)||e.inRange(c,...s))&&(h(o,r,this.fixedLeftWidth-this.scrollOffsetX,l,((i,s)=>e.inRange(i,...t)||e.inRange(s,...t))),h(n,r,0,l),h(a,r,this.wrapperWidth-this.fixedRightWidth,l)),i+this.dataRowHeights[d].value}),0)}renderSummary(){}renderScrollbar(){this.renderHorizontalScrollbar(),this.renderVerticalScrollbar()}renderVerticalScrollbar(){this.doRender((e=>{var t;const i=null===(t=this._nodeStore.getNode(u.SCROLLBAR_Y))||void 0===t?void 0:t[0];if(!i)return;const{scaleRatio:s,minScrollBarScaleRatio:h}=this.calcVerticalScrollbarRect(),o=this.scrollOffsetY/s/h;i.rect.y=this.headerHeight+o,e.fillStyle=i.style.background||r,e.roundRect(i.rect.x,i.rect.y,i.rect.width,i.rect.height,i.style.borderRadius),e.fill()}))}renderHorizontalScrollbar(){this.doRender((e=>{var t;const i=null===(t=this._nodeStore.getNode(u.SCROLLBAR_X))||void 0===t?void 0:t[0];if(!i)return;const{scaleRatio:s,minScrollBarScaleRatio:h}=this.calcHorizontalScrollbarRect(),o=this.scrollOffsetX/s/h;i.rect.x=o,e.fillStyle=i.style.background||r,e.roundRect(i.rect.x,i.rect.y,i.rect.width,i.rect.height,i.style.borderRadius),e.fill()}))}renderNoData(e="暂无数据"){this.doRender((t=>{const i=t.measureText(e).width;this.renderText({x:(this.wrapperWidth-i)/2,y:this.headerHeight+(this.wrapperHeight-this.headerHeight+14)/2,width:this.wrapperWidth,height:this.rowHeight,style:{textAlign:"center"},text:e,textWidth:i})}))}renderNode(e,t){this.doRender((()=>{var i,s,h;this.clearRect(t),e.style.background&&this.renderBackground(t,e.style.background),this.renderBorder(t);const r=e.type===c.TABLE_HEADER_COLUMN?null===(i=e.data)||void 0===i?void 0:i.column.name:`${null===(s=e.data)||void 0===s?void 0:s.rowIdx} 行 ${null===(h=e.data)||void 0===h?void 0:h.columnIdx} 列`;this.newRenderText(Object.assign(Object.assign({},t),{y:t.y+(t.height+this.fontSize)/2}),e.style,r)}))}renderCell(e,t,i=!1,s={}){this.clearRect(t),this.renderBorder(t);const h=Object.assign(Object.assign({},t),{text:i?e.name:s[e.key],y:t.y+this.fontSize+(t.height-this.fontSize)/2});this.renderText(h)}renderBorder(e){this.doRender((t=>{t.strokeStyle=d,t.lineWidth=1,t.strokeRect(e.x,e.y,e.width,e.height)}))}clearRect(e){this.getCanvasContext().clearRect(e.x,e.y,e.width,e.height)}renderBackground(e,t,i=0){this.doRender((s=>{s.roundRect(e.x,e.y,e.width,e.height,i),s.fillStyle=t,s.fill()}))}newRenderText(e,t,i){this.doRender((s=>{var h,r;const o=`${null!==(h=t.fontSize)&&void 0!==h?h:this.fontSize} ${null!==(r=t.fontFamily)&&void 0!==r?r:this.fontFamily} `;s.font=o,s.fillStyle="#000",s.fillText(i,e.x,e.y)}))}renderText(e){var t;const{x:i,y:s,height:h,width:r,text:o,textWidth:n,icon:a,style:d={},id:l,col:c}=e;"$sortable"!==l?(d.background&&this.renderBackground({x:i,y:s,width:r,height:h},d.background),this.context.font=null!==(t=d.color)&&void 0!==t?t:this.font,this.context.fillText(o,i,s)):this.renderSortIcon(i,s,h,r,c)}renderSortIcon(e,t,i,s,h){}setColumns(e=[]){this.rawColumns=e}setTableData(e=[]){this.tableData=e,this.resetTableDataRowHeight(e.length),this.resetScrollOffset(),this.initBodyNode()}initBodyNode(){console.time("tableBodyNode");const e=_({type:c.TABLE_BODY,data:{},rect:{x:this.fixedLeftWidth,y:this.headerHeight,width:this.wrapperWidth-this.fixedLeftWidth-this.fixedRightWidth,height:this.wrapperHeight-this.headerHeight-this.summaryHeight}});console.timeEnd("tableBodyNode"),console.time("fixedLeftNode");const t=_({type:c.TABLE_BODY,data:{},rect:{x:0,y:this.headerHeight,width:this.fixedLeftWidth,height:this.wrapperHeight-this.headerHeight-this.summaryHeight}});console.timeEnd("fixedLeftNode"),console.time("fixedRightNode");const i=_({type:c.TABLE_BODY,data:{},rect:{x:this.wrapperWidth-this.fixedRightWidth,y:this.headerHeight,width:this.fixedRightWidth,height:this.wrapperHeight-this.headerHeight-this.summaryHeight}});console.timeEnd("fixedRightNode");const s=(e,t,i)=>(s,h,r)=>{const o={right:h.x,children:[]};for(let h=0;h<s.length;h++){const n=s[h],a=_({type:c.TABLE_BODY_COLUMN,data:{row:t,column:n,rowIdx:i,columnIdx:h},rect:{x:o.right,y:e.top,width:n.$width.value,height:this.dataRowHeights[i].value},style:{fixed:r}});o.children.push(a),o.right+=n.$width.value}const n=_({type:c.TABLE_BODY_ROW,data:{row:t,rowIdx:i},rect:h,style:{fixed:r}});return v(n,o.children),n};this.tableData.reduce(((h,r,o)=>{const n=s(h,r,o),a=n(this._otherFlattenLeafNodeColumns,{x:this.fixedLeftWidth,y:h.top,width:this.contentWidth,height:this.dataRowHeights[o].value}),d=n(this._fixedLeftFlattenLeafNodeColumns,{x:0,y:h.top,width:this.fixedLeftWidth,height:this.dataRowHeights[o].value},"left"),l=n(this._fixedRightFlattenLeafNodeColumns,{x:this.wrapperWidth-this.fixedRightWidth,y:h.top,width:this.fixedRightWidth,height:this.dataRowHeights[o].value},"right");return v(e,a),v(t,d),v(i,l),{top:h.top+this.dataRowHeights[o].value}}),{top:this.headerHeight}),this._nodeStore.clearNode([u.BODY_FIXED_LEFT,u.BODY_FIXED_RIGHT,u.BODY_OTHER]),this._nodeStore.setNode(u.BODY_OTHER,e),this._nodeStore.setNode(u.BODY_FIXED_LEFT,t),this._nodeStore.setNode(u.BODY_FIXED_RIGHT,i)}getCellRect(e,t,i,s){return{}}initColumns(e){this.depth=this.getHeaderDepth(e),this.headerHeight=30*this.depth;const t=[...this.fixedLeftColumns,...this.fixedRightColumns,...this.otherColumns];t.length&&t.forEach((e=>{e.destroy()}));const i=e=>e.reduce(((e,t)=>{var s;return(null===(s=t.children)||void 0===s?void 0:s.length)?e.push(...i(t.children)):e.push(t),e}),[]),s=[],h=[],r=[];e.forEach((e=>{switch(e.fixed){case"left":s.push(e);break;case"right":h.push(e);break;default:r.push(e)}})),this.fixedLeftColumns=s.map((e=>new Column(e,{depth:this.depth}))),this.fixedRightColumns=h.map((e=>new Column(e,{depth:this.depth}))),this.otherColumns=r.map((e=>new Column(e,{depth:this.depth}))),this._fixedLeftFlattenLeafNodeColumns=i(this.fixedLeftColumns),this._fixedRightFlattenLeafNodeColumns=i(this.fixedRightColumns),this._otherFlattenLeafNodeColumns=i(this.otherColumns),this.subscribeColumnWidthChange(),this.initHeaderNode()}initHeaderNode(){const e=_({type:c.TABLE_HEADER,rect:{x:0,y:0,width:this.fixedLeftWidth,height:this.headerHeight}}),t=_({type:c.TABLE_HEADER,rect:{x:this.wrapperWidth-this.fixedRightWidth,y:0,width:this.fixedRightWidth,height:this.headerHeight}}),i=_({type:c.TABLE_HEADER,rect:{x:this.fixedLeftWidth,y:0,width:this.wrapperWidth-this.fixedLeftWidth-this.fixedRightWidth,height:this.headerHeight}}),s=(e,t,i)=>{const s=[],h=(e,t)=>{e.forEach((e=>{var r;const o=L.get(e),n=_({type:c.TABLE_HEADER_COLUMN,data:{column:e},rect:{x:o.value,y:t,width:e.$width.value,height:e.height},style:{fixed:i}});s.push(n),(null===(r=e.children)||void 0===r?void 0:r.length)&&h(e.children,t+e.height)}))},r=_({type:c.TABLE_HEADER_ROW,rect:t});return h(e,t.y),v(r,s),r},h=s(this.fixedLeftColumns,{x:0,y:0,width:this.fixedLeftWidth,height:this.headerHeight},"left"),r=s(this.fixedRightColumns,{x:this.wrapperWidth-this.fixedRightWidth,y:0,width:this.fixedRightWidth,height:this.headerHeight},"right"),o=s(this.otherColumns,{x:this.fixedLeftWidth,y:0,width:this.contentWidth,height:this.headerHeight});v(e,h),v(t,r),v(i,o),this._nodeStore.clearNode([u.HEADER_FIXED_LEFT,u.HEADER_FIXED_RIGHT,u.HEADER_OTHER]),this._nodeStore.setNode(u.HEADER_FIXED_LEFT,e),this._nodeStore.setNode(u.HEADER_FIXED_RIGHT,t),this._nodeStore.setNode(u.HEADER_OTHER,i)}subscribeColumnWidthChange(){const e=(e,i)=>{const s=()=>{const t=e.reduce(((e,t)=>e+t.$width.value),0);i(t)||this.setScrollbarInnerContentWidth()};s(),t.concat(...e.map((e=>e.$width))).pipe(t.debounceTime(100)).subscribe(s)},i=(e,t=0)=>{e.forEach((e=>{var s;(null===(s=e.children)||void 0===s?void 0:s.length)&&i(e.children,t);const h=L.get(e);h?h.value=t:L.set(e,{value:t}),t+=e.$width.value}))};e(this.fixedLeftColumns,(e=>{if(this.fixedLeftWidth===e)return!0;this.fixedLeftWidth=e,i(this.fixedLeftColumns)})),e(this.fixedRightColumns,(e=>{if(this.fixedRightWidth===e)return!0;this.fixedRightWidth=e,i(this.fixedRightColumns,this.wrapperWidth-this.fixedRightWidth)})),e(this.otherColumns,(e=>{if(this.contentWidth===e)return!0;this.contentWidth=e,i(this.otherColumns,this.fixedLeftWidth)}))}resetTableDataRowHeight(e){this.dataRowHeights=Array(e).fill("").map((()=>new t.BehaviorSubject(30))),this.calcBodyHeight(),this.subscribeTableDataRowHeightChange()}resetScrollOffset(){this.scrollOffsetX=0,this.scrollOffsetY=0}subscribeTableDataRowHeightChange(){this._tableDataRowHeightSubscription&&this._tableDataRowHeightSubscription.unsubscribe();t.from(this.dataRowHeights).pipe(t.mergeAll(),t.debounceTime(50)).subscribe((()=>{this.calcBodyHeight()}))}calcBodyHeight(){let e=0;this.dataRowHeights.forEach(((t,i)=>(this._rowTopMap.set(this.tableData[i],e),e+=t.value))),this.bodyHeight=e,this.setScrollbarInnerContentHeight()}setScrollbarInnerContentHeight(){var e;let t=null===(e=this._nodeStore.getNode(u.SCROLLBAR_Y))||void 0===e?void 0:e[0];t||(t=this.initVerticalScrollbarNode());const{rect:i}=this.calcVerticalScrollbarRect();E(t,i)}setScrollbarInnerContentWidth(){var e;let t=null===(e=this._nodeStore.getNode(u.SCROLLBAR_X))||void 0===e?void 0:e[0];t||(t=this.initHorizontalScrollbarNode());const{rect:i}=this.calcHorizontalScrollbarRect();E(t,i)}}i([g({enabled:!1,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[Object]),s("design:returntype",void 0)],CanvasTable.prototype,"getPointerEventNode",null),i([g({enabled:!1,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[Array]),s("design:returntype",void 0)],CanvasTable.prototype,"getVisibleRowNodes",null),i([g({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",void 0)],CanvasTable.prototype,"renderBody1",null),i([g({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[Array]),s("design:returntype",void 0)],CanvasTable.prototype,"setTableData",null),i([g({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",void 0)],CanvasTable.prototype,"initBodyNode",null),i([g({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[Array]),s("design:returntype",void 0)],CanvasTable.prototype,"initColumns",null),i([g({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",void 0)],CanvasTable.prototype,"initHeaderNode",null),i([g({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[Number]),s("design:returntype",void 0)],CanvasTable.prototype,"resetTableDataRowHeight",null),i([g({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",void 0)],CanvasTable.prototype,"resetScrollOffset",null);class BaseView{constructor(t={}){this.style={padding:[0,0,0,0],fontFamily:"Arial",fontSize:"14px",color:"#000"};const i=e.pick(t,l);Object.assign(this.style,i)}}class Column extends BaseView{constructor(e,{level:i=0,depth:s}){var h,r;super(e.style),this.fixed=!1,this.$width=new t.BehaviorSubject(0),this.height=0,this.level=1,this.$destroy=new t.Subject,this.children=[],this.name=e.name,this.key=e.key,this.level=i,this.fixed=null!==(h=e.fixed)&&void 0!==h&&h,this.$width.next(null!==(r=e.width)&&void 0!==r?r:120),this.initColumn(e,s),this.calcTotalWidth()}destroy(){this.children.forEach((e=>{e.destroy()})),this.children=[],this.$destroy.next(!0),this.$width.unsubscribe()}initColumn(e,t){var i,s;this.children=(null!==(i=e.children)&&void 0!==i?i:[]).map((e=>new Column(e,{level:this.level+1,depth:t}))),this.height=(null===(s=e.children)||void 0===s?void 0:s.length)?30:30*(t-this.level),this.subscribeChildrenWidthChange()}subscribeChildrenWidthChange(){t.concat(this.children.map((e=>e.$width))).pipe(t.debounceTime(200),t.takeUntil(this.$destroy)).subscribe(this.calcTotalWidth.bind(this))}calcTotalWidth(){this.$width.next(this.getTotalWidth())}getTotalWidth(){return this.children.length?this.children.reduce(((e,t)=>e+(t.$width.value>0?t.$width.value:120)),0):this.$width.value}}return CanvasTable}));
