!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("lodash"),require("rxjs")):"function"==typeof define&&define.amd?define(["lodash","rxjs"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasTable=e(t._,t.rxjs)}(this,(function(t,e){"use strict";function i(t,e,i,s){var r,h=arguments.length,o=h<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(r=t[n])&&(o=(h<3?r(o):h>3?r(e,i,o):r(e,i))||o);return h>3&&o&&Object.defineProperty(e,i,o),o}function s(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}const r="rgba(0, 0, 0, 0.25)";var h;!function(t){t[t.CELL_CLICK=0]="CELL_CLICK",t[t.HEADER_CELL_CLICK=1]="HEADER_CELL_CLICK",t[t.ROW_CLICK=2]="ROW_CLICK",t[t.COL_RESIZE=3]="COL_RESIZE",t[t.CELL_DBCLICK=4]="CELL_DBCLICK",t[t.ROW_DBCLICK=5]="ROW_DBCLICK",t[t.MOUSEMOVE=6]="MOUSEMOVE",t[t.MOUSELEAVE=7]="MOUSELEAVE"}(h||(h={}));const o={},n={},a="#000000",l=["padding","font","fontSize","color","background","borderRadius","border"];var d,c;function f(t){}function u(t={}){const{enabled:e,format:i,logger:s=f,id:r}=t;return function(t,h,o){const n=o.value;return o.value=function(...t){if(!e)return n.apply(this,t);const o=r?`${r} ${String(h)}`:`${String(h)}`,a=performance.now(),l=n.apply(this,t),d=performance.now(),c=function(t="simple",e,i){switch(t){case"simple":default:return`方法 ${e} 执行时间：${i.toFixed(2)}ms`;case"json":return JSON.stringify({method:e,time:i})}}(i,o,d-a);return null==s||s(c),l},o}}!function(t){t.TABLE="TABLE",t.TABLE_HEADER="TABLE_HEADER",t.TABLE_HEADER_ROW="TABLE_HEADER_ROW",t.TABLE_HEADER_COLUMN="TABLE_HEADER_COLUMN",t.TABLE_BODY="TABLE_BODY",t.TABLE_BODY_ROW="TABLE_BODY_ROW",t.TABLE_BODY_COLUMN="TABLE_BODY_COLUMN",t.TABLE_FOOTER="TABLE_FOOTER",t.TABLE_FOOTER_ROW="TABLE_FOOTER_ROW",t.TABLE_FOOTER_COLUMN="TABLE_FOOTER_COLUMN",t.TABLE_SCROLLBAR_X="TABLE_SCROLLBAR_X",t.TABLE_SCROLLBAR_Y="TABLE_SCROLLBAR_Y",t.DEFAULT="DEFAULT"}(d||(d={})),function(t){t.SCROLLBAR_X="SCROLLBAR_X",t.SCROLLBAR_Y="SCROLLBAR_Y",t.HEADER_FIXED_LEFT="HEADER_FIXED_LEFT",t.HEADER_FIXED_RIGHT="HEADER_FIXED_RIGHT",t.BODY_FIXED_LEFT="BODY_FIXED_LEFT",t.BODY_FIXED_RIGHT="BODY_FIXED_RIGHT",t.SUMMARY_FIXED_LEFT="SUMMARY_FIXED_LEFT",t.SUMMARY_FIXED_RIGHT="SUMMARY_FIXED_RIGHT",t.HEADER_OTHER="HEADER_OTHER",t.BODY_OTHER="BODY_OTHER",t.SUMMARY_OTHER="SUMMARY_OTHER"}(c||(c={}));const g=t=>{t.style.background="#ff0"},p=t=>{t.style.background="transparent"},R=t=>{var e;return{type:t.type,rect:t.rect,data:t.data,style:null!==(e=t.style)&&void 0!==e?e:{},_eventHandlers:{mouseenter:[g],mouseleave:[p],click:[]}}};function _(t,e){t.rect=e}function v(t,e){t.children||(t.children=[]),e=Array.isArray(e)?e:[e];for(const i of e)t.children.push(i)}function m(t,e,i){Array.isArray(t._eventHandlers[e])||(t._eventHandlers[e]=[]),t._eventHandlers[e].push(i)}function E(t,e,i){const s=t._eventHandlers[e];null==s||s.forEach((e=>{e(t,i)}))}class y{constructor(){this._store={},this._hoverNodeListMap=new Map}setNode(t,e){var i;this._store[t]||(this._store[t]=[]),null===(i=this._store[t])||void 0===i||i.push(e)}clearNode(t){t=Array.isArray(t)?t:[t];for(let e=0;e<t.length;e++){const i=t[e];this._store[i]=[]}}getNode(t){var e;return null!==(e=this._store[t])&&void 0!==e?e:[]}setHoverNodes(t){t.forEach((t=>{this._hoverNodeListMap.set(t,t)}))}getHoverNode(t){return this._hoverNodeListMap.get(t)}forEachHoverNode(t){this._hoverNodeListMap.forEach(t)}clearHoverNodes(){this._hoverNodeListMap.clear()}}class L{get font(){return`${this.fontSize}px ${this.fontFamily}`}get scrollOffsetX(){return this._scrollOffsetX}set scrollOffsetX(t){const e=this.wrapperWidth-this.fixedRightWidth-this.fixedLeftWidth,i=this.contentWidth-e;if((t=t<0?0:t>i?i:t)!==this._scrollOffsetX){this._scrollOffsetX=t;this._nodeStore.getNode(c.BODY_OTHER).forEach((e=>{e.scrollOffsetX=t}))}}get scrollOffsetY(){return this._scrollOffsetY}set scrollOffsetY(t){const e=this.wrapperHeight-this.headerHeight-this.summaryHeight,i=this.bodyHeight-e;if((t=t<0?0:t>i?i:t)!==this._scrollOffsetY){this._scrollOffsetY=t;const e=this._nodeStore.getNode(c.BODY_OTHER),i=this._nodeStore.getNode(c.BODY_FIXED_LEFT),s=this._nodeStore.getNode(c.BODY_FIXED_RIGHT);e.concat(i,s).forEach((e=>{e.scrollOffsetY=t})),this._verticalStartIdx=function(t,e,i){let s=0,r=0;for(let h=0;h<t.length;h++){if(s+=i(t[h]),s>e)return r;r=h}return r}(this.dataRowHeights,t,(t=>t.value))}}constructor(t){this.isInitialized=!1,this.scaleRatio=window.devicePixelRatio,this.canvasBaseStyle={},this.tableBaseStyle={},this.fontSize=14,this.fontFamily="Arial",this._scrollOffsetX=0,this._scrollOffsetY=0,this.dataRowHeights=[],this._tableDataRowHeightSubscription=null,this._displayRows=[],this._displayColumns=[],this._fixedLeftFlattenLeafNodeColumns=[],this._fixedRightFlattenLeafNodeColumns=[],this._otherFlattenLeafNodeColumns=[],this.rawColumns=[],this.depth=0,this.fixedLeftColumns=[],this.fixedRightColumns=[],this.otherColumns=[],this.columns=[],this.tableData=[],this.wrapperWidth=0,this.wrapperHeight=0,this.headerHeight=0,this.rowHeight=30,this.bodyHeight=0,this.summaryHeight=0,this.headerRowHeight=42,this.widthConfig={},this.minWidthTotal=0,this.defaultWidthTotal=0,this.currentColumns=[],this.bodyColumns=[],this.fixedLeftWidth=0,this.fixedRightWidth=0,this.contentWidth=0,this.hideHeader=!1,this._nodeStore=new y,this._horizontalCenterRange=[0,0],this._verticalCenterRange=[0,0],this._verticalStartIdx=0,this._horizontalStartIdx=0,this.init(t)}init(t){const e="function"==typeof t.target?t.target():t.target,{width:i,height:s}=e.getBoundingClientRect();this.wrapperWidth=i,this.wrapperHeight=s,this.appendEssentialElements(e),this.scaleRatio=this.scaleRatio<1?1:this.scaleRatio,this.setCanvasHeight(),this.setBaseStyle(),this.setColumns(t.columns),this.initColumns(this.rawColumns),this.setTableData(t.tableData),this.render(),this.isInitialized=!0}initTableScrollbar(){}calcVerticalScrollbarRect(){const t=this.wrapperHeight-this.headerHeight-this.summaryHeight,e=this.wrapperHeight-this.headerHeight,i=this.bodyHeight/e,s=t/i,r=s<10,h=r?10:s,o=r?(e-s)/(e-h):1;this.scrollOffsetY;return{rect:{x:this.wrapperWidth-this.summaryHeight-5,y:this.headerHeight,width:5,height:h},scaleRatio:i,minScrollBarScaleRatio:o}}initVerticalScrollbarNode(){const{rect:t,scaleRatio:e,minScrollBarScaleRatio:i}=this.calcVerticalScrollbarRect(),s=R({type:d.TABLE_SCROLLBAR_Y,rect:t,style:{background:r,borderRadius:5}});m(s,"mouseenter",(()=>{s.style.background="#ff0"})),m(s,"mouseleave",(()=>{s.style.background=r}));let h=!1,o=0,n=0;m(s,"mousedown",((t,s)=>{h=!0,o=s.pageY,n=this.scrollOffsetY/e/i,document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}));const a=t=>{if(h){const s=t.pageY-o;this.scrollOffsetY=(s+n)*e*i}},l=()=>{h=!1,o=0,n=0,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};return this._nodeStore.setNode(c.SCROLLBAR_Y,s),s}calcHorizontalScrollbarRect(){const t=this.wrapperWidth-this.fixedLeftWidth-this.fixedRightWidth,e=this.contentWidth/this.wrapperWidth,i=t/e,s=i<10,r=s?10:i,h=s?(this.wrapperWidth-i)/(this.wrapperWidth-r):1;return{rect:{x:this.scrollOffsetX/e/h,y:this.wrapperHeight-this.summaryHeight-5,width:r,height:5},scaleRatio:e,minScrollBarScaleRatio:h}}initHorizontalScrollbarNode(){const{rect:t}=this.calcHorizontalScrollbarRect(),e=R({type:d.TABLE_SCROLLBAR_Y,rect:t,style:{background:r,borderRadius:5}});m(e,"mouseenter",(()=>{e.style.background="#ff0"})),m(e,"mouseleave",(()=>{e.style.background=r}));let i=!1,s=0,h=0,o=1,n=1;m(e,"mousedown",((t,e)=>{const r=this.calcHorizontalScrollbarRect();o=r.scaleRatio,n=r.minScrollBarScaleRatio,i=!0,s=e.pageX,h=this.scrollOffsetX/o/n,document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}));const a=t=>{if(i){const e=(t.pageX-s+h)*o*n;this.scrollOffsetX=e}},l=()=>{i=!1,s=0,h=0,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};return this._nodeStore.setNode(c.SCROLLBAR_X,e),e}setBaseStyle(){Object.assign(this.canvasBaseStyle,n),Object.assign(this.tableBaseStyle,o)}setCanvasHeight(){this.context&&(this.context.canvas.height=this.calcRealPixel(this.wrapperHeight),this.context.translate(.5,.5),this.context.scale(this.scaleRatio,this.scaleRatio))}setDisplayRows(){}setDisplayColumns(){const e=[this.scrollOffsetX,this.wrapperWidth-this.fixedRightWidth],{columns:i}=this.otherColumns.reduce(((i,s)=>{const r=i.left,h=s.$width.value+i.left;return i.left+=h,(t.inRange(r,...e)||t.inRange(h,...e)||t.inRange(e[0],r,h)&&t.inRange(e[1],r,h))&&i.columns.push(s),i}),{columns:[],left:0});this._displayColumns=i}createCanvas(){const t=document.createElement("canvas");return t.width=this.calcRealPixel(this.wrapperWidth),t.height=this.calcRealPixel(this.wrapperHeight),t.style.width=`${this.wrapperWidth}px`,t.style.height=`${this.wrapperHeight}px`,this.context=t.getContext("2d"),this.bindCanvasWheelEvent(t),this.bindCanvasMouseEvent(t),t}getPointerEventNode(e){const{x:i,y:s}=e;let r=[];const h=(e,r,o=[],n={scrollOffsetX:0,scrollOffsetY:0})=>{const a=o[o.length-1],{scrollOffsetX:l=0,scrollOffsetY:c=0}=a||{},f={scrollOffsetX:l+n.scrollOffsetX,scrollOffsetY:c+n.scrollOffsetY};for(let n=0;n<r.length;n++){const a=r[n],{rect:{x:l,y:c,height:u,width:g},children:p}=a,R=l-f.scrollOffsetX,_=R+g;if(t.inRange(i,R,_)){const i=c-f.scrollOffsetY,r=i+u;if(t.inRange(s,i,r)){if(o.push(a),!(null==p?void 0:p.length))break;if(a.type===d.TABLE_BODY){const t=this.getVisibleRowNodes(p);h(e,t,o,f)}else h(e,p,o,f)}}}return o};for(const t in c){const e=c[t],o=this._nodeStore.getNode(e);if((null==o?void 0:o.length)&&(r=h({x:i,y:s},o),null==r?void 0:r.length))break}return r}bindCanvasMouseEvent(t){t.addEventListener("mousedown",(t=>{this._nodeStore.forEachHoverNode((e=>{E(e,"mousedown",t)}))})),document.addEventListener("mouseup",(t=>{this._nodeStore.forEachHoverNode((e=>{E(e,"mouseup",t)}))})),t.addEventListener("click",(t=>{this._nodeStore.forEachHoverNode((e=>{E(e,"click",t)}))})),t.addEventListener("mousemove",(t=>{const e=this.getPointerEventNode({x:t.offsetX,y:t.offsetY});this._nodeStore.forEachHoverNode((i=>{e.includes(i)?E(i,"mousemove",t):E(i,"mouseleave",t)})),e.reverse().forEach((e=>{E(e,"mouseenter",t)})),this._nodeStore.clearHoverNodes(),this._nodeStore.setHoverNodes(e)})),t.addEventListener("mouseleave",(t=>{this._nodeStore.forEachHoverNode((e=>{E(e,"mouseleave",t)}))}))}bindCanvasWheelEvent(t){t.addEventListener("wheel",(t=>{t.stopPropagation(),t.preventDefault(),this.scrollOffsetX+=t.deltaX,this.scrollOffsetY+=t.deltaY}))}calcRealPixel(t){return t*this.scaleRatio}appendEssentialElements(t){const e=this.createCanvas();t.appendChild(e)}getCanvasContext(){return this.context}rerender(){this.isInitialized&&this.render()}doRender(t){const e=this.getCanvasContext();e.beginPath(),e.save(),t(e),e.restore(),e.closePath()}render(){requestAnimationFrame((()=>{var t;const e=this.getCanvasContext();e.clearRect(-1,-1,this.wrapperWidth+1,this.wrapperHeight+1),e.beginPath(),(null===(t=this.tableData)||void 0===t?void 0:t.length)?this.renderBody():this.renderNoData(),this.renderHeader(),this.renderSummary(),this.renderScrollbar(),this.render()}))}getHeaderDepth(t){let e=0;const i=(t,s=1)=>{e=Math.max(e,s),t.forEach((t=>{var e;(null===(e=t.children)||void 0===e?void 0:e.length)&&i(t.children,s+1)}))};return i(t),e}fillSelectionFormatter(t){}getCellWidth(t,e,i){return 0}pushSlot(t){}getRectOpts(t,e=0){return{x:60*(t+1),y:(e+1)*this.rowHeight,width:30,height:this.rowHeight}}getVisibleColumns(){return this.columns}renderHeader(){const e=[this.fixedLeftWidth,this.wrapperWidth-this.fixedRightWidth+1];R({type:d.TABLE_HEADER,rect:{x:0,y:0,width:this.wrapperWidth,height:this.headerHeight}});const i=(t,e,s,r=(()=>!0))=>{t.reduce(((t,e)=>{var h;const{left:o}=t,n=o+e.$width.value;if(r(o,n)){const t={x:o,y:s,width:e.$width.value,height:e.height};this.renderCell(e,t,!0),(null===(h=e.children)||void 0===h?void 0:h.length)&&i(e.children,o,s+e.height,r)}return t.left+=e.$width.value,t}),{left:e})};i(this.otherColumns,this.fixedLeftWidth-this.scrollOffsetX,0,((i,s)=>t.inRange(i,...e)||t.inRange(s,...e))),i(this.fixedLeftColumns,0,0),i(this.fixedRightColumns,this.wrapperWidth-this.fixedRightWidth,0)}getVisibleRowNodes(e){const{_horizontalCenterRange:i,_verticalCenterRange:s}=this,r=[];let h=!1;for(let i=this._verticalStartIdx;i<e.length;i++){const o=e[i],{y:n,height:a}=o.rect,l=n-this.scrollOffsetY,d=l+a,c=t.inRange(l,...s)||t.inRange(d,...s);if(c)h=!0,r.push(o);else if(h&&!c)break}return r}renderNodes(e=[]){const{_horizontalCenterRange:i,_verticalCenterRange:s}=this;e.forEach((e=>{switch(e.type){case d.TABLE_BODY:{const{children:t=[]}=e,i=this.getVisibleRowNodes(t);this.renderNodes(i);break}case d.TABLE_BODY_ROW:{const{children:s=[]}=e,r=[];let h=!1;for(let o=this._horizontalStartIdx;o<s.length;o++){const n=s[o],{x:a,width:l}=n.rect,d=a-this.scrollOffsetX,c=d+l,f=e.style.fixed||t.inRange(d,...i)||t.inRange(c,...i);if(f)h=!0,r.push(n);else if(h&&!f)break}this.renderNodes(r);break}case d.TABLE_BODY_COLUMN:const{rect:{x:s,y:r,width:h,height:o},style:{fixed:n,background:a}}=e,l={x:n?s:s-this.scrollOffsetX,y:r-this.scrollOffsetY,width:h,height:o,bg:a};this.renderNode(e,l)}}))}renderBody(){const t=[this.fixedLeftWidth,this.wrapperWidth-this.fixedRightWidth+1],e=this.headerHeight,i=[e,e+(this.wrapperHeight-this.headerHeight-this.summaryHeight)+1];this._horizontalCenterRange=t,this._verticalCenterRange=i;const s=this._nodeStore.getNode(c.BODY_OTHER),r=this._nodeStore.getNode(c.BODY_FIXED_LEFT),h=this._nodeStore.getNode(c.BODY_FIXED_RIGHT),o=s.concat(r,h);this.renderNodes(o)}renderBody1(){const e=[this.fixedLeftWidth,this.wrapperWidth-this.fixedRightWidth+1],i=this.headerHeight,s=[i,i+(this.wrapperHeight-this.headerHeight-this.summaryHeight)+1],r=(t,e,i,s,r=(()=>!0))=>{t.reduce(((t,i)=>{const{left:h}=t,o=h+i.$width.value;if(r(h,o)){const t={x:h,y:s,width:i.$width.value,height:this.rowHeight};this.renderCell(i,t,!1,e)}return t.left+=i.$width.value,t}),{left:i})},h=this.tableData,o=this._otherFlattenLeafNodeColumns,n=this._fixedLeftFlattenLeafNodeColumns,a=this._fixedRightFlattenLeafNodeColumns;h.reduce(((i,h,l)=>{const d=i+this.headerHeight-this.scrollOffsetY,c=d+this.dataRowHeights[l].value;return(t.inRange(d,...s)||t.inRange(c,...s))&&(r(o,h,this.fixedLeftWidth-this.scrollOffsetX,d,((i,s)=>t.inRange(i,...e)||t.inRange(s,...e))),r(n,h,0,d),r(a,h,this.wrapperWidth-this.fixedRightWidth,d)),i+this.dataRowHeights[l].value}),0)}renderSummary(){}renderScrollbar(){this.renderHorizontalScrollbar(),this.renderVerticalScrollbar()}renderVerticalScrollbar(){this.doRender((t=>{var e;const i=null===(e=this._nodeStore.getNode(c.SCROLLBAR_Y))||void 0===e?void 0:e[0];if(!i)return;const{scaleRatio:s,minScrollBarScaleRatio:h}=this.calcVerticalScrollbarRect(),o=this.scrollOffsetY/s/h;i.rect.y=this.headerHeight+o,t.fillStyle=i.style.background||r,t.roundRect(i.rect.x,i.rect.y,i.rect.width,i.rect.height,i.style.borderRadius),t.fill()}))}renderHorizontalScrollbar(){this.doRender((t=>{var e;const i=null===(e=this._nodeStore.getNode(c.SCROLLBAR_X))||void 0===e?void 0:e[0];if(!i)return;const{scaleRatio:s,minScrollBarScaleRatio:h}=this.calcHorizontalScrollbarRect(),o=this.scrollOffsetX/s/h;i.rect.x=o,t.fillStyle=i.style.background||r,t.roundRect(i.rect.x,i.rect.y,i.rect.width,i.rect.height,i.style.borderRadius),t.fill()}))}renderNoData(t="暂无数据"){this.doRender((e=>{const i=e.measureText(t).width;this.renderText({x:(this.wrapperWidth-i)/2,y:this.headerHeight+(this.wrapperHeight-this.headerHeight+14)/2,width:this.wrapperWidth,height:this.rowHeight,style:{textAlign:"center"},text:t,textWidth:i})}))}renderNode(t,e){this.doRender((i=>{var s,r;this.clearRect(e),t.style.background&&this.renderBackground(e,t.style.background),this.renderBorder(e),this.newRenderText(Object.assign(Object.assign({},e),{y:e.y+(e.height+this.fontSize)/2}),t.style,`${null===(s=t.data)||void 0===s?void 0:s.rowIdx} 行 ${null===(r=t.data)||void 0===r?void 0:r.columnIdx} 列`)}))}renderCell(t,e,i=!1,s={}){this.clearRect(e),this.renderBorder(e);const r=Object.assign(Object.assign({},e),{text:i?t.name:s[t.key],y:e.y+this.fontSize+(e.height-this.fontSize)/2});this.renderText(r)}renderBorder(t){this.doRender((e=>{e.strokeStyle=a,e.lineWidth=1,e.strokeRect(t.x,t.y,t.width,t.height)}))}clearRect(t){this.getCanvasContext().clearRect(t.x,t.y,t.width,t.height)}renderBackground(t,e,i=0){this.doRender((s=>{s.roundRect(t.x,t.y,t.width,t.height,i),s.fillStyle=e,s.fill()}))}newRenderText(t,e,i){this.doRender((s=>{var r,h;const o=`${null!==(r=e.fontSize)&&void 0!==r?r:this.fontSize} ${null!==(h=e.fontFamily)&&void 0!==h?h:this.fontFamily} `;s.font=o,s.fillStyle="#000",s.fillText(i,t.x,t.y)}))}renderText(t){var e;const{x:i,y:s,height:r,width:h,text:o,textWidth:n,icon:a,style:l={},id:d,col:c}=t;"$sortable"!==d?(l.background&&this.renderBackground({x:i,y:s,width:h,height:r},l.background),this.context.font=null!==(e=l.color)&&void 0!==e?e:this.font,this.context.fillText(o,i,s)):this.renderSortIcon(i,s,r,h,c)}renderSortIcon(t,e,i,s,r){}setColumns(t=[]){this.rawColumns=t}setTableData(t=[]){this.tableData=t,this.resetTableDataRowHeight(t.length),this.resetScrollOffset();const e=R({type:d.TABLE_BODY,data:{},rect:{x:this.fixedLeftWidth,y:this.headerHeight,width:this.wrapperWidth-this.fixedLeftWidth-this.fixedRightWidth,height:this.wrapperHeight-this.headerHeight-this.summaryHeight}}),i=R({type:d.TABLE_BODY,data:{},rect:{x:0,y:this.headerHeight,width:this.fixedLeftWidth,height:this.wrapperHeight-this.headerHeight-this.summaryHeight}}),s=R({type:d.TABLE_BODY,data:{},rect:{x:this.wrapperWidth-this.fixedRightWidth,y:this.headerHeight,width:this.fixedRightWidth,height:this.wrapperHeight-this.headerHeight-this.summaryHeight}}),r=(t,e,i)=>(s,r,h)=>{const o={right:r.x,children:[]};for(let r=0;r<s.length;r++){const n=s[r],a=R({type:d.TABLE_BODY_COLUMN,data:{row:e,column:n,rowIdx:i,columnIdx:r},rect:{x:o.right,y:t.top,width:n.$width.value,height:this.dataRowHeights[i].value},style:{fixed:h}});o.children.push(a),o.right+=n.$width.value}const n=R({type:d.TABLE_BODY_ROW,data:{row:e,rowIdx:i},rect:r,style:{fixed:h}});return v(n,o.children),n};t.reduce(((t,h,o)=>{const n=r(t,h,o),a=n(this._otherFlattenLeafNodeColumns,{x:this.fixedLeftWidth,y:t.top,width:this.contentWidth,height:this.dataRowHeights[o].value}),l=n(this._fixedLeftFlattenLeafNodeColumns,{x:0,y:t.top,width:this.fixedLeftWidth,height:this.dataRowHeights[o].value},"left"),d=n(this._fixedRightFlattenLeafNodeColumns,{x:this.wrapperWidth-this.fixedRightWidth,y:t.top,width:this.fixedRightWidth,height:this.dataRowHeights[o].value},"right");return v(e,a),v(i,l),v(s,d),{top:t.top+this.dataRowHeights[o].value}}),{top:this.headerHeight}),this._nodeStore.clearNode([c.BODY_FIXED_LEFT,c.BODY_FIXED_RIGHT,c.BODY_OTHER]),this._nodeStore.setNode(c.BODY_OTHER,e),this._nodeStore.setNode(c.BODY_FIXED_LEFT,i),this._nodeStore.setNode(c.BODY_FIXED_RIGHT,s)}getCellRect(t,e,i,s){return{}}initColumns(t){const e=[...this.fixedLeftColumns,...this.fixedRightColumns,...this.otherColumns];e.length&&e.forEach((t=>{t.destroy()}));const i=t=>t.reduce(((t,e)=>{var s;return(null===(s=e.children)||void 0===s?void 0:s.length)?t.push(...i(e.children)):t.push(e),t}),[]),s=[],r=[],h=[];t.forEach((t=>{switch(t.fixed){case"left":s.push(t);break;case"right":r.push(t);break;default:h.push(t)}})),this.depth=this.getHeaderDepth(t),this.headerHeight=30*this.depth,this.fixedLeftColumns=s.map((t=>new b(t,{depth:this.depth}))),this.fixedRightColumns=r.map((t=>new b(t,{depth:this.depth}))),this.otherColumns=h.map((t=>new b(t,{depth:this.depth}))),this._fixedLeftFlattenLeafNodeColumns=i(this.fixedLeftColumns),this._fixedRightFlattenLeafNodeColumns=i(this.fixedRightColumns),this._otherFlattenLeafNodeColumns=i(this.otherColumns),this.subscribeColumnWidthChange()}subscribeColumnWidthChange(){const t=(t,i)=>{e.concat(t.map((t=>t.$width))).pipe(e.debounceTime(200)).subscribe((()=>{const e=t.reduce(((t,e)=>t+e.$width.value),0);i(e)||this.setScrollbarInnerContentWidth()}))};t(this.fixedLeftColumns,(t=>{if(this.fixedLeftWidth===t)return!0;this.fixedLeftWidth=t})),t(this.fixedRightColumns,(t=>{if(this.fixedRightWidth===t)return!0;this.fixedRightWidth=t})),t(this.otherColumns,(t=>{if(this.contentWidth===t)return!0;this.contentWidth=t}))}resetTableDataRowHeight(t){this.dataRowHeights=Array(t).fill(new e.BehaviorSubject(30)),this.subscribeTableDataRowHeightChange()}resetScrollOffset(){this.scrollOffsetX=0,this.scrollOffsetY=0}subscribeTableDataRowHeightChange(){this._tableDataRowHeightSubscription&&this._tableDataRowHeightSubscription.unsubscribe(),this._tableDataRowHeightSubscription=e.concat(this.dataRowHeights).pipe(e.debounceTime(200)).subscribe((()=>{this.bodyHeight=this.dataRowHeights.reduce(((t,e)=>t+e.value),0),this.setScrollbarInnerContentHeight()}))}setScrollbarInnerContentHeight(){var t;let e=null===(t=this._nodeStore.getNode(c.SCROLLBAR_Y))||void 0===t?void 0:t[0];e||(e=this.initVerticalScrollbarNode());const{rect:i}=this.calcVerticalScrollbarRect();_(e,i)}setScrollbarInnerContentWidth(){var t;let e=null===(t=this._nodeStore.getNode(c.SCROLLBAR_X))||void 0===t?void 0:t[0];e||(e=this.initHorizontalScrollbarNode());const{rect:i}=this.calcHorizontalScrollbarRect();_(e,i)}}i([u({enabled:!1,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[Object]),s("design:returntype",void 0)],L.prototype,"getPointerEventNode",null),i([u({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",void 0)],L.prototype,"renderBody1",null),i([u({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[Array]),s("design:returntype",void 0)],L.prototype,"setTableData",null),i([u({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[Array]),s("design:returntype",void 0)],L.prototype,"initColumns",null),i([u({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[Number]),s("design:returntype",void 0)],L.prototype,"resetTableDataRowHeight",null),i([u({enabled:!0,id:"CanvasTable"}),s("design:type",Function),s("design:paramtypes",[]),s("design:returntype",void 0)],L.prototype,"resetScrollOffset",null);class O{constructor(e={}){this.style={padding:[0,0,0,0],fontFamily:"Arial",fontSize:"14px",color:"#000"};const i=t.pick(e,l);Object.assign(this.style,i)}}class b extends O{constructor(t,{level:i=0,depth:s}){var r,h;super(t.style),this.fixed=!1,this.$width=new e.BehaviorSubject(0),this.height=0,this.level=1,this.$destroy=new e.Subject,this.children=[],this.name=t.name,this.key=t.key,this.level=i,this.fixed=null!==(r=t.fixed)&&void 0!==r&&r,this.$width.next(null!==(h=t.width)&&void 0!==h?h:120),this.initColumn(t,s),this.calcTotalWidth()}destroy(){this.children.forEach((t=>{t.destroy()})),this.children=[],this.$destroy.next(!0),this.$width.unsubscribe()}initColumn(t,e){var i,s;this.children=(null!==(i=t.children)&&void 0!==i?i:[]).map((t=>new b(t,{level:this.level+1,depth:e}))),this.height=(null===(s=t.children)||void 0===s?void 0:s.length)?30:30*(e-this.level),this.subscribeChildrenWidthChange()}subscribeChildrenWidthChange(){e.concat(this.children.map((t=>t.$width))).pipe(e.debounceTime(200),e.takeUntil(this.$destroy)).subscribe(this.calcTotalWidth.bind(this))}calcTotalWidth(){this.$width.next(this.getTotalWidth())}getTotalWidth(){return this.children.length?this.children.reduce(((t,e)=>t+(e.$width.value>0?e.$width.value:120)),0):this.$width.value}}return L}));
